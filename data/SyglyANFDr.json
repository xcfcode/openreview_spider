{"paper": {"title": "SGD with Hardness Weighted Sampling for Distributionally Robust Deep Learning", "authors": ["Lucas Fidon", "Sebastien Ourselin", "Tom Vercauteren"], "authorids": ["lucas.fidon@kcl.ac.uk", "sebastien.ourselin@kcl.ac.uk", "tom.vercauteren@kcl.ac.uk"], "summary": "An SGD-based method for training deep neural networks with distributionally robust optimization", "abstract": "Distributionally Robust Optimization (DRO) has been proposed as an alternative to Empirical Risk Minimization (ERM) in order to account for potential biases in the training data distribution. However, its use in deep learning has been severely restricted due to the relative inefficiency of the optimizers available for DRO compared to the wide-spread Stochastic Gradient Descent (SGD) based optimizers for deep learning with ERM. In this work, we demonstrate that SGD with hardness weighted sampling is a principled and efficient optimization method for DRO in machine learning and is particularly suited in the context of deep learning. Similar to a hard example mining strategy in essence and in practice, the proposed algorithm is straightforward to implement and computationally as efficient as SGD-based optimizers used for deep learning.  It only requires adding a softmax layer and maintaining an history of the loss values for each training example to compute adaptive sampling probabilities.  In contrast to typical ad hoc hard mining approaches, and exploiting recent theoretical results in deep learning optimization, we prove the convergence of our DRO algorithm for over-parameterized deep learning networks with ReLU activation and finite  number  of  layers  and parameters.  Preliminary results demonstrate the feasibility and usefulness of our approach.", "keywords": ["distributionally robust optimization", "distributionally robust deep learning", "over-parameterized deep neural networks", "deep neural networks", "AI safety", "hard example mining"]}, "meta": {"decision": "Reject", "comment": "This paper proposes a modification of SGD to do distributionally-robust optimization of deep networks.  The main idea is sensible enough, however, the inadequate handling of baselines and relatively toy nature of the experiments means that this paper needs more work to be accepted."}, "review": {"Hkx76YqLqr": {"type": "review", "replyto": "SyglyANFDr", "review": "This paper proposes a method for Distributionally Robust Optimization (DRO). DRO has recently been proposed (Namkoong and Duchi 2016 and others) as a robust learning framework compared to Empirical Risk Minimization (ERM).  My analysis of this work in short is that the problem that this paper addresses is interesting and not yet solved. This paper proposes a simple and efficient method for DRO. However, convergence guarantees are weak which is reflected in their weak experimental results. And for a 10-page paper, the writing has to improve quite a lot.\n\nSummary of contributions:\nThe phi-divergence variation of DRO introduces a min-max objective that minimizes a maximally reweighted empirical risk. The main contribution of this work is as follows:\n- Show that for two common phi-divergences (KL-divergence and Pearson-chi2 divergence), the inner maximization has a simple solution for the weights that depends on the value of the loss on the training set.\n- Use the above algorithm and modify SGD by changing the sampling of data according to the weights.\n- Convergence proofs for the above algorithm for wide networks (not necessarily infinite-width).\n\n\nCons:\n- Fig 1, ERM should not be so bad as if predicting randomly. This suggests a problem in the experimental setting. At least more ablation study is needed, e.g. try varying the percentage of data kept and show the final test accuracy as a function of this percentage for ERM. In the worst case, the accuracy for ERM should be ~90% on 9 classes and zero on 10th which is ~80% for uniform test accuracy. Another point, what is the train accuracy on cats? ERM should be overfitting to those few cats in the training set and achieve some non-zero accuracy at test. But it seems the test accuracy is almost exactly 0 at test time.\n- In Theorem 5.1 that provides convergence proofs, the learning rate eta_exact has a dependence on 1/beta, which means much smaller learning rates should be used for the proposed method. However, in the experiments it seems that the same learning rate is used for all methods. This seems to trouble the convergence very clearly as the curves start to fluctuate considerably by increasing for larger betas. There is no bounds on beta which in practice can force us to use orders of magnitude smaller learning rates.\n- Section 4.3 aims at linking hard negative mining to the proposed method. What they actually do is propose a new definition for hard-negative mining which is satisfied by the proposed method. There is little basis for suggesting this definition. There are myriads of work on hard-negative mining and suggesting a new definition needs a more thorough study of related works.\n- Section A.1.1 argues we would stop ERM when it plateaus, but it doesn't look like it has plateaued in fig 2 left.\n- Section A.3, I'm not sure lr=1 would be stable wide resnet. Maybe there is a problem with the experimental setting.\n- There is such much non-crucial details in the main body that increased the main text to 10 pages. At least 2 pages could be saved by moving details of theorems and convergence results to the appendix.\n\nAfter rebuttal:\nI'm keeping more score. The manuscript has been improved quite a lot.  My main concern remains the experiments. Both texts and mathematical statements still need more edits.\n\nThe authors have completely removed experiments on cifar10. Paper now has only one set of experiments on MNIST with little ablation study. I still think my suggested ablation study is interesting. As a minimal sanity check, I'd like to see the performance of DRO on the original MNIST dataset. Basically, how much do we lose by using a robust method on a balanced dataset? Even with full ablation studies, I don't think MNIST is not enough for testing methods based on hard-negative mining.", "title": "Official Blind Review #4", "rating": "3: Weak Reject", "confidence": 3}, "rJgnJ3NojB": {"type": "rebuttal", "replyto": "Hkx76YqLqr", "comment": "[Writing] \nWe have worked on the writing and have now reduced the main text to 8 pages by moving the details of the convergence theorems to the appendix as you suggested.\n\n[CIFAR10]\nPlease see our common reply \"Experiments on CIFAR10 and DRO with momentum\".\nThank you.", "title": "CIFAR10 experiment and Writing"}, "r1lhujNssH": {"type": "rebuttal", "replyto": "BklCcLSacS", "comment": "Please see our common reply \"Experiments on CIFAR10 and DRO with momentum\".\nThank you.", "title": "Experiment on CIFAR10"}, "SylmXo4joB": {"type": "rebuttal", "replyto": "HklDPH9QsS", "comment": "Thank you for taking the time to review our submission and for your insights.\n\nWe have grouped the reply to your questions on the momentum and our reply to the common concern of the reviewers regarding our results on CIFAR10 in the common reply \"Experiments on CIFAR10 and DRO with momentum\".", "title": "Reply to your comments"}, "BJer0FEjjr": {"type": "rebuttal", "replyto": "SyglyANFDr", "comment": "In this comment we reply to the concerns of the reviewers regarding the experiment on CIFAR10.\nWe also feedback on the concern of AnonReviewer3 regarding the introduction of momentum in the proposed algorithm.\n\n[CIFAR10 training issues for the baseline] \nThe baseline approach [1] shuffles the training dataset at each epoch. By default, it uses the last batch as is even if it is much smaller than the standard batch size. For the CIFAR10 training set with 10% of the cats, it turned out that the last batch was very small, which in turn led to unstable training.  \n\nAfter changing this behavior so as to drop the last batch, the baseline now trains more smoothly even with the large learning rate used in our experiments. \n\nAs such, even though figure 1 of our first submission showed an accurate depiction of the behavior of the baseline method using all the default parameters except for the learning rate, the effect measured was not related to our method. The difference mostly came from the noisy gradients occurring from the small last batch. As a result, this experiment has been removed from the manuscript. \n\n[Momentum] \nIn the baseline approach [1], the best performance is obtained with SGD with momentum and a learning rate decay schedule. \n\nFollowing preliminary experiments, we have found that using momentum updates with DRO is not straightforward. We think that this is due to the inner maximization of DRO (as suggested by AnonReviewer3), and that specific momentum updates for DRO are needed. \n\nFor large values of beta (beta>10) the WideResNet_28_10 with DRO does not train properly with momentum, except if we reduce the learning rate by two orders of magnitude. In the latter case, it trains very slowly and cannot be properly tested given the duration of the rebuttal period. It is possible that tuning the momentum parameter for DRO could tackle this issue, but we have not yet had the opportunity to evaluate it. \n\nFor low values of beta (beta<=1), we can train the WideResNet_28_10 with DRO with momentum and using the same hyperparameters as the baseline without DRO. With such small betas, we obtain the same accuracy as the baseline since the distributionally robust loss is very close to the mean loss (ERM case). \n\nInvestigating efficient means of introducing momentum within DRO requires further work. We have commented on this in the conclusion.  \n\n\n[1] Wide residual networks. Zagoruyko, S., & Komodakis, N. (2016). ", "title": "Experiments on CIFAR10 and DRO with momentum"}, "HklDPH9QsS": {"type": "review", "replyto": "SyglyANFDr", "review": "Disclaimer: I was able to read the other reviews and the author\u2019s responses before finalizing this review.\n\nThe paper proposes an easy-to-implement algorithm for DRO on example weights, with the same computational cost as SGD.  The algorithm is based on hardness weighted sampling and links are shown to hard example mining.  Convergence results are shown for (finitely) wide networks.  Additionally, the paper claims to demonstrate the usefulness of the algorithm in deep learning.\n\nI am unable to assess how the convergence results place in the literature, but I believe they motivate the algorithm.  The claims of practical usefulness in deep learning do not seem supported by the provided empirical evidence.\nFor the CIFAR experiments, the ERM baseline does not seem to train - probably due to the choice of learning rate.  This makes it unclear how the proposed algorithm compares.  They claim the algorithm is more robust to the learning rate, so is it possible to train with the original learning rate used for the ERM baseline?  Why was a different learning rate chosen?\n\nIf the experimental results showed an improvement over a properly trained ERM baseline on CIFAR I would lean toward weak accept.\n\nMany state-of-the-art deep learning pipelines do not use plain SGD - for example, the WideResNet you used on CIFAR. How is Algorithm 1 used on these? Do we only make changes to the update on line 24?  Using momentum with nested optimization can introduce instabilities. Perhaps combining momentum with nested optimization of loss weights and parameters is why the baseline does not train?  Maybe you could try an architecture that trained using vanilla SGD, so you can better leverage your theoretical results?\n\nIt would provide evidence of the usefulness of the algorithm if we could take various pipelines and just drop their optimizer updates into algorithm 1 - hopefully without having to spend time re-tuning their optimizer parameters. It would also be nice to see the training loss/accuracy - perhaps over all classes and just cats - in the appendix.\n\n\nThings to improve that did not impact the score:\n\n(Page 1) \u201cin term\u201d -> \u201cin terms\u201d\n(Page 1 & 2) \u201can history\u201d -> \u201ca history\u201d\n(Page 2) \u201cOptmization\u201d -> \u201cOptimization\u201d\n(Page 5) \u201callows to link\u201d -> \u201callows us to link\u201d\n(Page 7) \u201cwe focus at\u201d -> \u201cwe focus on\u201d\n(Page 8) \u201callows to guarantee\u201d -> \u201callows us to guarantee\u201d\n(Page 19) \u201ccontinous\u201d -> \u201ccontinuous", "title": "Official Blind Review #3", "rating": "3: Weak Reject", "confidence": 1}, "H1g4j-CzoB": {"type": "rebuttal", "replyto": "BklCcLSacS", "comment": "Thank you for taking the time to review our submission and for your insights. \n\nIn this first answer to your review, to foster rapid discussion iterations, we feedback on some of your concerns below. We will come back to you shortly regarding your other concerns, as we are running additional experiments and working on the manuscript. \n\n[On the novelty of the paper] \nTo the best of our knowledge, our paper is the first to propose a weighted sampling strategy for deep DRO. In addition to offer a pragmatic algorithm, we also mathematically prove the convergence of our approach. Research on DRO in the non-convex setting has only started to appear recently. The differences between existing recent works and our algorithm are discussed in section 4 of our submission. The timeliness of our work is further confirmed by the fact that another work on a similar topic was independently submitted at ICLR this year [1]. \n \n[Clarification following your comment: \u201cThe DRO problem studied in this paper is relatively easy, in the sense that the inner maximization has close form solution\u201d] \nIt is correct that there is a closed form solution for the inner maximization problem, provided we have access to the full exact per-sample loss history.  However, this is not possible to evaluate efficiently in practice. To address this limitation, we propose to exploit a stale loss history that is continuously updated. One of our main contributions is to show that this approach is not only intuitive but also leads to provable convergence. \n\n[Contributions compared to Allen-Zhu et al. 2019] \nThere were several important technical challenges that made the extension of the result of Allen-Zhu et al. 2019 from ERM to our algorithm for DRO non-trivial. We used the framework of Allen-Zhu as a backbone for our proofs, but in contrast to the ERM case of Allen-Zhu: \n    - The DRO loss is not linear with respect to the per-sample loss because of the max operator. This linearity property is used many times in the proofs of Allen-Zhu et al. 2019. \n    - The sampling distribution is in our case dynamic and not uniform. \n    - Another substantial challenge is the fact that our sampling used with the stale loss only approximates the closed form solution of the internal max problem of the DRO problem. \n\nAddressing these points required substantial work, as can be found in appendix C.6 and C.7 (pages 21-33 in the first version of the submission) \n\n \n[Question 1: about the link between dynamic sampling (our approach) and re-weighting] \nReweighting while sampling according to the uniform distribution is of course possible. This would correspond to using importance sampling (up to a multiplicative factor n=number of training samples).  \nImportance sampling is often used when we cannot sample with respect to the desired distribution or to reduce the variance of the stochastic estimation of the gradient [2,3]. \n\nIn our case, the proposed hardness weighted sampler is a better approximation of the target distribution than the uniform distribution, which motivates its use. \n \n\n[Question 2: about training longer in the MNIST experiment] \nPlease see our common comment about our experiments on MNIST. \n \n[Question 3: about a link between the Focal Loss and DRO] \nIt is true that both our hardness weighted sampler and the Focal Loss are motivated by hard examples mining. However, the weights used in the Focal Loss were defined heuristically. In addition, those weights are specific to the cross entropy, while our optimization method can be used with any loss function.  \n\nEven though the weights of the Focal Loss can be expressed as a function of the cross entropy loss, It is not clear how these weights can be justified a posteriori as the result of the inner maximization problem of DRO with the cross entropy loss and a given phi-divergence. In particular, the vector of the weights of the Focal Loss is not a probability vector. Therefore, it does not trivially belong to the space of admissible solutions for the inner maximization optimization problem of DRO. More work would be required to establish if deeper connections exists between cross-entropy based DRO and the Focal Loss. \n\n\nReferences:\n[1] Distributionally Robust Neural Networks. (under submission at ICLR 2020. Paper1796). https://openreview.net/forum?id=ryxGuJrFvS&noteId=BJexEXB09r  \n\n[2] An introduction to graphical models. MI Jordan, 2005. \nhttp://www.cs.cmu.edu/~lebanon/pub/book/ \n\n[3] Methods of Reducing Sample Size in Monte Carlo Computations. H. Khan et al, 1953. ", "title": "First feedbacks"}, "Hygk1ZCGjB": {"type": "rebuttal", "replyto": "Hkx76YqLqr", "comment": "Thank you for taking the time to review our submission and for your insights. \n\nIn this first answer to your review, to foster rapid discussion iterations, we feedback on some of your concerns below. We will come back to you shortly regarding your other concerns, as we are running additional experiments and working on the manuscript. \n\n[Definition of Hard Example Mining Sampling] \nTo the best of our knowledge, there is no widely accepted definition for Hard Example Mining in the literature. Yet, we need a definition to study the link between DRO and Hard Example Mining. We do not pretend to propose a definition for all possible Hard Example Mining methods, which is why we used the term \u201cHard Example Mining Sampling\u201d rather than only \u201cHard Example Mining\u201d. \n\nOur definition further address only Online Hard Example Mining as defined in [1] since there is no discrete switching between training and hard examples mining. To make it clearer that our definition corresponds only to a subset of Hard Example Mining methods, we have now renamed it as \u201cOnline Hard Example Mining Sampling\u201d in the revised version of the submission. \n \n[The learning rate is too high for the large values of beta] \nPlease see our common comment about our experiments on MNIST. \n\n[When does ERM plateaus in fig.2 left?] \nPlease see our common comment about our experiments on MNIST. \n\n[Reducing the size of the main text] \nWe are working on moving the details of section 5 to the appendix as you suggested to improve clarity. \n\n \nReferences:\n[1] Training Region-based Object Detectors with Online Hard Example Mining. A. Srivastava et al. 2016 ", "title": "First feedbacks"}, "B1ggdeAfiS": {"type": "rebuttal", "replyto": "SyglyANFDr", "comment": "We thank the reviewers for taking the time to review our submission and for their insights. \n\nIn this comment, we feedback on the concerns of the reviewers regarding our experiments on MNIST.\n\n[Training longer in the MNIST experiment] \nWe have expanded our experiments with three times more training epochs as per the reviewer suggestions (please see the updated Fig. 2 in the revised submission). \n\nAs suggested by AnonReviewer2 \u201cI'm not sure they will finally achieve the same accuracy (the same optimum)\u201d, the updated Fig. 2 suggests that after a large number of iterations, ERM and DRO converge to different local minima, and that DRO leads to a better generalization on the under-represented class. \n\n[On Early-stopping: AnonReviewer4 \u201cSection A.1.1 argues we would stop ERM when it plateaus, but it doesn't look like it has plateaued in fig 2 left.\u201d] \nWe agree that our statement could be made more accurate. When we used the term \u201cplateau\u201d it was related to the choice of the patience parameter in early-stopping. In the left panel of Fig.2, there is no improvement of ERM of more than 0.04% in accuracy between epoch 20 and 30. For a patience lesser than 10 epochs, one would stop training for ERM before epoch 30. To clarify this point, we rephrased or statement as: \u201cif the patience parameter is too low, ERM might be considered to plateau at an epoch at which it has an accuracy of 0 on the under-represented class\u201d.  \n\nIt is also worth noting, that this experiment corresponds to the best-case scenario in which the testing set is used for choosing the optimal number of epochs (i.e. there is no bias at all between the validation and the testing distributions). \n\n[On instabilities in the learning curve on the testing set] \nAnonReviewer4 suggested that the instabilities observed during the first epochs in the learning curves on the testing set for large values of beta could be due to a value of the learning rate that is too large: \u201cin the experiments it seems that the same learning rate is used for all methods. This seems to trouble the convergence very clearly as the curves start to fluctuate considerably by increasing for larger betas.\u201d \n\nFollowing this suggestion, we tried to divide the learning rate by 10 or 100. However, we observed no reduction of the instabilities on the testing set. \n\nLooking at the learning curves **on the training set**, we found that the loss curves for beta=10 were actually stable there. However, we have observed that during the iterations for which instabilities appears **on the testing set**, the standard deviation of the loss **on the training set** is relatively high (i.e. the hardness weighted probability is further away from the uniform distribution). \n\nThis suggests that the apparent instabilities **on the testing set** are not related to a too high learning rate, but to differences between the DRO loss and the ERM loss. \n\nFollowing this observation, we increased beta to 100 for the same learning rate and it led to higher accuracy on the testing set (see the updated fig. 2). ", "title": "Experiments on MNIST"}, "BklCcLSacS": {"type": "review", "replyto": "SyglyANFDr", "review": "This paper studies the Distributionally Robust Optimization (DRO), in the sense that the weights assigned to the training data can change, but the training data itself remains unchanged. They demonstrate that SGD with hardness weighted sampling is a principled and efficient optimization method for DRO in machine learning and is particularly suited in the context of deep learning. On the theoretical side, they prove the convergence of our DRO algorithm for over-parameterized\ndeep learning networks with ReLU activation and finite number of layers and parameters.\n\nThe DRO problem studied in this paper is relatively easy, in the sense that the inner maximization has close form solution (at least for KL divergence). Therefore, the proposed method is straightforward. All the derivations in Section 3 and 4 are strainghtforward and sensible. I do not know any paper that has proposed Algorithm 1 (or something similar) before, but I will be surprised there is not. I do not check the derivations in Section 5, but I suppose that it is a small modification of the proof in Allen-Zhu et al., 2019. I suppose that the theorem is correct, but it provides nearly no practical guidance.\n\nIn Algorithm 1 Line 18-19, the algorithm proposes to do sampling with replacement using the softmax probability \\hat{p}. How about directly multipling the weights \\hat{p} to the current minibatch of samples. (i.e., re-weighting the samples instead of re-sampling the samples). What's the difference between these two choices?\n\nSecond, both experiments are not convincing enough. In the CIFAR10 experiment (Figure 1), the baseline method ERM is too low. I guess that this low number is due to the large initial learning rate 1. The authors should provide the best performance IRM can achieve, and compare with the best performance DRO can achieve. Although the authors are claiming that the proposed DRO works with larger learning rate, Figure 1 (Left) simply gives readers the wrong information that ERM does not work. \"Figure 2 suggests that if we train ERM long enough it will converge to the same accuracy as DRO.\" The objectives of ERM and DRO are different. Their accuracy may become closer to each other, but I'm not sure they will finally achieve the same accuracy (the same optimum). Can the authors elaborate on this?\n\nFinally, the focal loss has achieved good empirical results in object detection. I feel that it can be formulated as a special case of the Equation (2) and Algorithm 1, by picking up some proper \\phi-divergence and using the (un-normalized) re-weighting scheme. It will good if the authors can provide a principled view of focal loss through the lens of DRO. \n", "title": "Official Blind Review #2", "rating": "3: Weak Reject", "confidence": 2}}}